from moviepy.editor import *
from gtts import gTTS
from dotenv import load_dotenv
import os
import requests

# âœ… Load .env
load_dotenv()
PIXABAY_KEY = os.getenv("PIXABAY_API_KEY")

# ğŸ“ Teks narasi
narration_text = """
Di masa depan, teknologi membantu manusia menghadapi perubahan iklim.
"""

# ğŸ¤ TTS
tts = gTTS(narration_text, lang='id')
tts.save("voice.mp3")

# ğŸ” Ambil kata kunci pencarian dari kalimat pertama
search_query = narration_text.strip().split(".")[0].replace(" ", "+")

# ğŸ” Fungsi cari gambar Pixabay
def get_pixabay_image(query, key):
    url = f"https://pixabay.com/api/?key={key}&q={query}&image_type=photo&orientation=horizontal&per_page=3"
    try:
        response = requests.get(url, timeout=10)
        data = response.json()
        if "hits" in data and len(data["hits"]) > 0:
            return data["hits"][0]["largeImageURL"]
    except Exception as e:
        print(f"âš ï¸ Pixabay error: {e}")
    return None

# ğŸ“¥ Download gambar dari URL
def download_image(url, filename):
    try:
        img_data = requests.get(url, timeout=10).content
        with open(filename, "wb") as f:
            f.write(img_data)
        return filename
    except Exception as e:
        print(f"âš ï¸ Gagal download gambar: {e}")
        return None

# ğŸ“¥ Coba pakai Pixabay
image_url = get_pixabay_image(search_query, PIXABAY_KEY)
image_file = download_image(image_url, "downloaded.jpg") if image_url else None

# ğŸï¸ Ambil background clip
def load_background(duration):
    if image_file and os.path.exists(image_file):
        print("âœ… Menggunakan gambar dari Pixabay")
        return ImageClip(image_file).set_duration(duration).resize(height=720)
    elif os.path.exists("fallback.jpg"):
        print("âš ï¸ Fallback: menggunakan fallback.jpg lokal")
        return ImageClip("fallback.jpg").set_duration(duration).resize(height=720)
    else:
        raise FileNotFoundError("âŒ Tidak ditemukan gambar dari Pixabay maupun fallback.jpg")

# ğŸ§ Audio
audio = AudioFileClip("voice.mp3")
duration = audio.duration

# ğŸ–¼ï¸ Background
background = load_background(duration).set_audio(audio)

# ğŸ“ Tambahkan teks ke video
text_clip = TextClip(narration_text.strip(), fontsize=38, color='white', font='DejaVu-Sans',
                     method='caption', size=(1000, None)).set_position(("center", "bottom")).set_duration(duration)

# ğŸ”„ Gabungkan semuanya
final_video = CompositeVideoClip([background, text_clip])

# ğŸ’¾ Simpan ke MP4
final_video.write_videofile("film_output.mp4", fps=24)

